<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style>
body {
  margin: 0;
  padding: 0;
  background: black;
}
#titlediv {
  font-family: monosapce;
  text-align: center;
  font-size:48px;
  position:fixed; 
  width:100%; 
  height:50px; 
  color:white;
  background-color:black; 
  padding:5px; 
  top:0px; 
  overflow-y: auto;
}

#attackdiv {
  font-family: monosapce;
  font-size:10px;
  position:fixed; 
  width:100%; 
  height:100px; 
  color:white;
  background-color:black; 
  padding:5px; 
  bottom:0px; 
  overflow-y: auto;
}

</style>
</head>
<body>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="http://datamaps.github.io/scripts/datamaps.world.min.js?v=1"></script>
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <audio id="starwars" src="Blaster-Solo.wav" preload="auto"></audio>
  <audio id="tng" src="tng_torpedo_clean.mp3" preload="auto"></audio>
  <audio id="b5" src="B5-interceptor1.wav" preload="auto"></audio>
  <audio id="wargames" src="WarGames-KeyPress.wav" preload="auto"></audio>

  <center><div id="container1" style="position: relative; width: 100vw; height: 100vh; max-width:100%; max-height:100%"></div></center>
  <div id="titlediv">IPew Attack Map</div>
  <div id="attackdiv"></div>
    
  <script>

    attack_min = 100 ;
    attack_max = 3000 ;

    attack_type = [ "port scan", "ssh brute force", "SYN FLOOD", "Spotter", "Heartbleed", "POODLE", "Sharknado" ] ;

    $.extend({
      getUrlVars: function(){
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
          hash = hashes[i].split('=');
          vars.push(hash[0]);
          vars[hash[0]] = hash[1];
        }
        return vars;
      },
      getUrlVar: function(name){
        return $.getUrlVars()[name];
      }
    });

    var bad_day = $.getUrlVar('bad_day');
    var org_name = $.getUrlVar('org_name');
    var china_mode = $.getUrlVar('china_mode');
    var tng = $.getUrlVar('tng');
    var wargames = $.getUrlVar('wargames');
    var b5 = $.getUrlVar('b5');

    snd_id = "starwars" ;

    if (typeof tng !== 'undefined'){
      snd_id = "tng" ;
    }

    if (typeof b5 !== 'undefined'){
      snd_id = "b5" ;
    }

    if (typeof wargames !== 'undefined'){
      snd_id = "wargames" ;
    }

    if (typeof bad_day !== 'undefined'){
      attack_min=100;
      attack_max=100;
    }

    if (typeof org_name !== 'undefined') {
      $("#titlediv").html(org_name + " IPew Attack Map")
    }

    if (typeof china_mode !== 'undefined') {
      attack_type = [ "ZOMGOSH CHINA!!!!!!" ];
    }

    function FixedQueue( size, initialValues ){
      initialValues = (initialValues || []);
      var queue = Array.apply( null, initialValues );
      queue.fixedSize = size;
      queue.push = FixedQueue.push;
      queue.splice = FixedQueue.splice;
      queue.unshift = FixedQueue.unshift;
      FixedQueue.trimTail.call( queue );
      return( queue );
    }

    FixedQueue.trimHead = function(){
      if (this.length <= this.fixedSize){ return; }
      Array.prototype.splice.call( this, 0, (this.length - this.fixedSize) );
    };

    FixedQueue.trimTail = function(){
      if (this.length <= this.fixedSize) { return; }
      Array.prototype.splice.call( this, this.fixedSize, (this.length - this.fixedSize)
      );
    };
 
    FixedQueue.wrapMethod = function( methodName, trimMethod ){
      var wrapper = function(){
        var method = Array.prototype[ methodName ];
        var result = method.apply( this, arguments );
        trimMethod.call( this );
        return( result ); 
      };
      return( wrapper ); 
    };

    FixedQueue.push = FixedQueue.wrapMethod( "push", FixedQueue.trimHead );
 
    FixedQueue.splice = FixedQueue.wrapMethod( "splice", FixedQueue.trimTail );

    FixedQueue.unshift = FixedQueue.wrapMethod( "unshift", FixedQueue.trimTail );
 

    var map = new Datamap({

        scope: 'world',
        element: document.getElementById('container1'),
        projection: 'winkel3',
        
        fills: { defaultFill: 'black', },

        geographyConfig: {
          dataUrl: null, //if not null, datamaps will fetch the map JSON (currently only supports topojson)
          hideAntarctica: true,
          borderWidth: 0.75,
          borderColor: '#4393c3',
          popupTemplate: function(geography, data) { //this function should just return a string
            return '<div class="hoverinfo" style="color:white;background:black">' + geography.properties.name + '</div>';
          },
          popupOnHover: true, //disable the popup while hovering
          highlightOnHover: false,
          highlightFillColor: 'black',
          highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
          highlightBorderWidth: 2
        },
        
      })

    var centers = [] ;
    // d3.csv("country_latlon.csv", function(data) { centers = data; });
    d3.tsv("country_centroids_primary.csv", function(data) { centers = data; });


    var hits = FixedQueue( 7, [  ] );
    var boom = FixedQueue( 7, [  ] );

    function getRandomInt(min, max) {return Math.floor(Math.random() * (max - min + 1)) + min;}

    function getOctet() {return Math.round(Math.random()*255);}

    function randomIP () { return(getOctet() + '.' + getOctet() + '.' + getOctet() + '.' + getOctet()); } 

    var attacks = {
     
        failed: 0,
        success_count: 0,
     
        interval: getRandomInt(attack_min, attack_max),
     
        init: function(){
           setTimeout(
               jQuery.proxy(this.getData, this),
               this.interval
           );
        },
     
       getData: function() {

           var self = this;
           var src = Math.floor((Math.random() * centers.length));

           if (typeof china_mode !== 'undefined') {
             src = 33;
           }

           dst = Math.floor((Math.random() * centers.length));
           if ((dst == src) || (dst == 33)) {
            dst = src + 1 ;
            if (dst > centers.length-1) { dst = centers.length-1 }
           }

           document.getElementById(snd_id).load();
           document.getElementById(snd_id).play();

           hits.push( { origin : { latitude: +centers[src].LAT, longitude: +centers[src].LONG },
                        destination : { latitude: +centers[dst].LAT, longitude: +centers[dst].LONG } } );


           map.arc(hits, {strokeWidth: 2});

           which_attack = attack_type[Math.floor((Math.random() * attack_type.length))];

           boom.push( { radius: 7, latitude: +centers[dst].LAT, longitude: +centers[dst].LONG,
                        fillOpacity: 0.5, attk: which_attack} );

           map.bubbles(boom, {
                popupTemplate: function(geo, data) {
                  return '<div class="hoverinfo">' + data.attk + '</div>';
                }
            });

           $('#attackdiv').append(centers[src]["SHORT_NAME"] + " (" + randomIP() + ") " +
                                  " <span style='color:red'>attacks</span> " + 
                                  centers[dst]["SHORT_NAME"]+  " (" + randomIP() + ") " + 
                                  " <span style='color:steelblue'>(" + which_attack + ")</span> " +
                                  "<br/>");
           $('#attackdiv').animate({scrollTop: $('#attackdiv').prop("scrollHeight")}, 500);

           this.interval = getRandomInt(attack_min, attack_max);
           this.init() ;
       },
     
    };
     
    attacks.init();    

    d3.select(window).on('resize', function(){ location.reload(); });

    </script>
</body>
</html>
